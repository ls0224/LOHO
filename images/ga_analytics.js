$(document).ready(function(){var a=function(){setTimeout(function(){if(typeof dataLayer!="undefined"){getAllData();return}setTimeout(a,500)},500)};a();$("#changeCity a").on("click",function(g){var f=$(this),c=f.attr("ga-type"),d=f[0].tagName.toLowerCase()=="a"&&f.attr("href")&&f.attr("href").indexOf("javascript")<0;if(d){if(navigator.userAgent.indexOf("MSIE")>=0){window.event.returnValue=false}else{g.preventDefault()}var b=getDataByType(f,c);pushData(b);setTimeout(function(){d?window.location.href=f.attr("href"):""},200)}});$(document).on("click","[ga-type]",function(g){var f=$(this),c=f.attr("ga-type"),d=f[0].tagName.toLowerCase()=="a"&&f.attr("href");if(d){if(navigator.userAgent.indexOf("MSIE")>=0){window.event.returnValue=false}else{g.preventDefault()}}if(c=="AppointmentSubmit"||c=="AppointmentSendAddress"){if(!$("#mphone").val()&&!$("#mobile").val()&&!$("input[name=mobile]").val()&&!$(".map-phone").val()){return}}if(c=="AddToCart"){if(f.html().indexOf("镜片")>=0&&!parseFloat($("select[name=rSph]").val())&&!parseFloat($("select[name=lSph]").val())){return}if(f.html().indexOf("确定购买")>=0&&!parseFloat($("select[name=rSph]").val())&&!parseFloat($("select[name=lSph]").val())){return}}var b=getDataByType(f,c);if(d){window.open(f.attr("href"));pushData(b)}})});function pushData(a){if(typeof dataLayer=="undefined"||typeof a=="undefined"){return}dataLayer.push(a)}function getDataByType(y,g){var j=window.location.href;if(g=="AppointmentSubmit"){var w=$("select[name=city]").val()?$("select[name=city]").val():$(".cid").val(),z=$(".store_cidshop").val()?$(".store_cidshop").val():$("select[name=bespoke_shop]").val(),q=$(".activ_web_mis_area_textarea").val()?$(".activ_web_mis_area_textarea").val():$("#date_picie").val(),u=$("option[value="+w+"]").eq(0).text(),k=$("option[value="+z+"]").eq(0).text();return{event:g,shop:u+"-"+k,need:q}}else{if(g=="AppointmentSendAddress"){var d=$(".check-allmap").find("#curCity").text(),b=$("option[value="+$("select[name=city]").val()+"]").eq(0).text(),C=$("#mCSB_1").find(".on").parent().prev().text(),t=$(".u-popbox-popbox").find("option[value="+$(".store_cidshop").val()+"]").eq(0).text(),s=$(".check-allmap").find("option[value="+$("#store_list").val()+"]").eq(0).text(),r=$("#mCSB_1").find(".on").text(),u=d?d:(b?b:C),k=t?t:(s?s:r);return{event:g,shop:u+"-"+k,need:""}}else{if(g=="SwitchCity"){return{event:g,cityA:$(".hd-cityShop .hd-here").html(),cityB:y.html()}}else{if(g=="ProductClick"){var p=y.attr("ga-from")&&y.attr("ga-from").indexOf("index")>=0,B=p?y.attr("ga-from").replace("index",""):"";return{event:"ProductClick",ecommerce:{click:{actionField:{list:j.replace("http://www.loho88.com","")+B},products:[{id:getGoodsIdByUrl(y.attr("href")),price:y.attr("ga-price"),position:y.attr("ga-position"),dimension1:"Normal"}]}}}}else{if(g=="PromotionClick"){return{event:g,ecommerce:{promoClick:{promotions:[{id:y.attr("href").replace("http://www.loho88.com",""),name:y.attr("title"),creative:y.attr("ga-creative"),position:y.attr("ga-position")}]}}}}else{if(g=="AddToCart"||g=="PreSale"){var h=$("#content"),o={},c=parseInt(h.attr("ga-cat-id"));if(c==11){var x=$("div.optometry-grid"),i=x.find("[name=rSph]").val(),f=x.find("[name=lSph]").val(),m=i+"/"+x.find("[name=rCyl]").val()+"*"+x.find("[name=rAxis]").val(),l=f+"/"+x.find("[name=lCyl]").val()+"*"+x.find("[name=lAxis]").val();if(i=="0.00"&&f=="0.00"){return}o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:$("#number").val(),dimension1:h.attr("ga-status"),dimension2:x.find("[name=type]").find("option[value="+x.find("[name=type]").val()+"]").text(),dimension3:m,dimension4:l,dimension5:x.find("[name=pd]").val(),dimension6:x.find("[name=add]").val()?x.find("[name=add]").val():""}}else{if(c==12){var v=$(".degrees-lst .r_sph .on").text(),A=$(".degrees-lst .l_sph .on").text();if(!v&&!A){return}o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:parseInt($("#r_number").val())+parseInt($("#l_number").val()),dimension1:h.attr("ga-status"),dimension2:"近视",dimension3:v,dimension4:A}}else{o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:$("#number").val()?$("#number").val():$("#l_number").val(),dimension1:h.attr("ga-status"),}}}if(g=="PreSale"){o.dimension1="Pre-sale"}return{event:g,ecommerce:{add:{products:[o]}}}}else{if(g=="AddToCartBundle"){var h=$("#content"),n=parseInt(h.attr("ga-cat-id")),e=[];if(n==12){var x=$(".m-buypack"),v=x.find("[name=r_sph]").val(),A=x.find("[name=l_sph]").val();if(!v&&!A){return}o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:parseInt($("#r_number").val())+parseInt($("#l_number").val()),dimension1:h.attr("ga-status"),dimension2:"近视",dimension3:v,dimension4:A,dimension7:y.attr("ga-package-name")+"-"+y.attr("ga-package-id")}}else{if(n==10){var x=$("div.optometry-grid"),i=x.find("[name=rSph]").val(),f=x.find("[name=lSph]").val(),m=i+"/"+x.find("[name=rCyl]").val()+"*"+x.find("[name=rAxis]").val(),l=f+"/"+x.find("[name=lCyl]").val()+"*"+x.find("[name=lAxis]").val();if(i=="0.00"&&f=="0.00"){return}o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:$("#number").val(),dimension1:h.attr("ga-status"),dimension7:y.attr("ga-package-name")+"-"+y.attr("ga-package-id")};var a={id:y.attr("ga-goods-id")?y.attr("ga-goods-id"):getGoodsIdByUrl($(".goods-pack .on .item").find("a").eq(0).attr("href")),price:y.attr("ga-price")?y.attr("ga-price"):$(".goods-pack .on .item").find(".price").text(),quantity:$("#number").val(),dimension1:h.attr("ga-status"),dimension2:x.find("[name=type]").find("option[value="+x.find("[name=type]").val()+"]").text(),dimension3:m,dimension4:l,dimension5:x.find("[name=pd]").val(),dimension6:x.find("[name=add]").val()?x.find("[name=add]").val():"",dimension7:y.attr("ga-package-name")+"-"+y.attr("ga-package-id")};e.push(a)}else{o={id:h.attr("ga-goods-id"),price:h.attr("ga-price"),quantity:$("#number").val()?$("#number").val():$("#l_number").val(),dimension1:h.attr("ga-status"),dimension7:y.attr("ga-package-name")+"-"+y.attr("ga-package-id")}}}e.push(o);return{event:"AddToCartBundle",ecommerce:{add:{products:e}}}}else{return{event:g}}}}}}}}}function getAllData(){var j=$("[ga-type=PromotionClick]"),p=$("[ga-type=ProductClick]"),h=window.location.href,a=/goods-(.*)\./,r,c=[],e=[],b=[],f,l,t=[],g=a.test(h),q=h.indexOf("list-")>0||h.indexOf("search")>0,d=$("#content");if(g){r={id:d.attr("ga-goods-id"),price:d.attr("ga-price"),dimension1:d.attr("ga-status")};if(!$(".goods-advance").hasClass("dn")){r.dimension1="Pre-sale"}var k=$(".goods-pack .set-meal").length==0?$(".goods-pack .yx-set-meal"):$(".goods-pack .set-meal"),n=$("#goods-recom li"),m=$(".goods-pack li");k.each(function(u,w){var i=$(w),z=i.find(".item"),x=z.find("a"),v=x.eq(0).attr("href"),y={id:getGoodsIdByUrl(v),price:z.find(".price").text(),list:h.replace("http://www.loho88.com","")+">产品优惠搭配",position:u+1,dimension1:"Promotional",dimension7:m.eq(u).text().replace("|","")+"-"+m.eq(u).attr("ga-package-id")};x.attr("ga-position",u+1);x.attr("ga-price",y.price);c.push(y)});n.each(function(u,w){var i=$(w),x=i.find("a"),v=x.attr("href"),y={id:getGoodsIdByUrl(v),price:i.find(".price").find("span").eq(0).text(),list:h.replace("http://www.loho88.com","")+">您可能还喜欢",position:u+1,dimension1:parseInt(x.attr("ga-dimension1"))>0?"Promotional":"Normal"};x.attr("ga-position",u+1);x.attr("ga-dimension1",y.dimension1);x.attr("ga-price",i.find(".price").find("span").eq(0).text());if(x.attr("ga-add")&&x.attr("ga-add")==1){c.push(y)}})}else{p.each(function(v,y){var u=$(y),x=u.attr("ga-from")&&u.attr("ga-from").indexOf("index")>=0,i=x?u.attr("ga-from").replace("index",""):"",w=u.attr("href"),z={id:getGoodsIdByUrl(w),price:u.attr("ga-price"),list:h.replace("http://www.loho88.com","")+i,position:x?(u.attr("ga-base")?parseInt(u.attr("ga-position"))+1:u.attr("ga-position")):c.length+1,dimension1:u.attr("ga-dimension1")?"Promotional":"Normal"};if(u.attr("ga-add")&&u.attr("ga-add")==1){c.push(z);u.attr("ga-position",z.position)}else{u.attr("ga-position",z.position-1)}})}j.each(function(u,v){var i=$(v),w={id:i.attr("href").replace("http://www.loho88.com",""),name:i.attr("title"),creative:i.attr("ga-creative"),position:i.attr("ga-base")?parseInt(i.attr("ga-position"))+1:i.attr("ga-position")};i.attr("ga-position",w.position);e.push(w)});if(g){f={event:"Load",ecommerce:{detail:{products:[r]},promoView:{promotions:e},impressions:c}};window.gaDetail=r;pushData(f)}else{if(q){var s=splitArr(c);for(var o=0;o<s.length;o++){if(o==s.length-1){f={event:"Load",ecommerce:{impressions:s[o],promoView:{promotions:e}}};pushData(f)}else{f={event:"Load",ecommerce:{impressions:s[o],promoView:{promotions:""}}};pushData(f)}}}else{f={event:"Load",ecommerce:{impressions:c}};c.length>0?pushData(f):"";t=splitArr(e);for(var o=0;o<t.length;o++){l={event:"LoadPromotions",ecommerce:{promoView:{promotions:t[o]}}};pushData(l)}}}}function splitArr(a){var c=[];if(a.length<30){c.push(a);return c}for(var b=0;b<a.length;b++){if(b+29>a.length){c.push(a.slice(b,a.length))}else{c.push(a.slice(b,b+30))}b=b+29}return c}function getGoodsIdByUrl(b){var c=/goods-(.*)\.html/,a=c.exec(b);return a[1]};